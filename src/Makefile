# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    Makefile                                           :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: ebmarque <ebmarque@student.42porto.com     +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2024/09/13 10:07:04 by ebmarque          #+#    #+#              #
#    Updated: 2024/09/14 13:49:17 by ebmarque         ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

# Variables
DOCKER_COMPOSE = sudo docker compose
DOCKER = sudo docker
DATA_DIR = /home/ebarque/data

# Targets
all: up

up:
	@echo "\033[1;32m"
	@echo "╔─────────────────────────────────────────────────────────────────────────────────╗"
	@echo "│███████╗███████╗██████╗ ██╗   ██╗██╗ ██████╗███████╗███████╗    ██╗   ██╗██████╗ │"
	@echo "│██╔════╝██╔════╝██╔══██╗██║   ██║██║██╔════╝██╔════╝██╔════╝    ██║   ██║██╔══██╗│"
	@echo "│███████╗█████╗  ██████╔╝██║   ██║██║██║     █████╗  ███████╗    ██║   ██║██████╔╝│"
	@echo "│╚════██║██╔══╝  ██╔══██╗╚██╗ ██╔╝██║██║     ██╔══╝  ╚════██║    ██║   ██║██╔═══╝ │"
	@echo "│███████║███████╗██║  ██║ ╚████╔╝ ██║╚██████╗███████╗███████║    ╚██████╔╝██║     │"
	@echo "│╚══════╝╚══════╝╚═╝  ╚═╝  ╚═══╝  ╚═╝ ╚═════╝╚══════╝╚══════╝     ╚═════╝ ╚═╝     │"
	@echo "╚─────────────────────────────────────────────────────────────────────────────────╝"
	@echo "\033[0m"
	@sudo mkdir -p $(DATA_DIR)/html $(DATA_DIR)/mysql
	@$(DOCKER_COMPOSE) up -d --build
	@echo "\033[1;32mApplication started.\033[0m"

down:
	@echo "\033[1;31m"
	@echo "╔──────────────────────────────────────────────────────────────────╗"
	@echo "│ ███████╗████████╗ ██████╗ ██████╗ ██████╗ ██╗███╗   ██╗ ██████╗  │"
	@echo "│ ██╔════╝╚══██╔══╝██╔═══██╗██╔══██╗██╔══██╗██║████╗  ██║██╔════╝  │"
	@echo "│ ███████╗   ██║   ██║   ██║██████╔╝██████╔╝██║██╔██╗ ██║██║  ███╗ │"
	@echo "│ ╚════██║   ██║   ██║   ██║██╔═══╝ ██╔═══╝ ██║██║╚██╗██║██║   ██║ │"
	@echo "│ ███████║   ██║   ╚██████╔╝██║     ██║     ██║██║ ╚████║╚██████╔╝ │"
	@echo "│ ╚══════╝   ╚═╝    ╚═════╝ ╚═╝     ╚═╝     ╚═╝╚═╝  ╚═══╝ ╚═════╝  │"
	@echo "╚──────────────────────────────────────────────────────────────────╝"
	@echo "\033[0m"
	@$(DOCKER_COMPOSE) down
	@echo "\033[1;31mApplication stopped.\033[0m"

clean:
	@echo "\033[1;33m"
	@echo "\t╔──────────────────────────────────────────╗"
	@echo "\t│ ██████╗██╗     ███████╗ █████╗ ███╗   ██╗│"
	@echo "\t│██╔════╝██║     ██╔════╝██╔══██╗████╗  ██║│"
	@echo "\t│██║     ██║     █████╗  ███████║██╔██╗ ██║│"
	@echo "\t│██║     ██║     ██╔══╝  ██╔══██║██║╚██╗██║│"
	@echo "\t│╚██████╗███████╗███████╗██║  ██║██║ ╚████║│"
	@echo "\t│ ╚═════╝╚══════╝╚══════╝╚═╝  ╚═╝╚═╝  ╚═══╝│"
	@echo "\t╚──────────────────────────────────────────╝"
	@echo "\033[0m"
	@$(DOCKER_COMPOSE) down
	@$(DOCKER) image rm -f $$(sudo docker image ls -q) 2>>app.log || true
	@echo "\t\t      \033[1;33mCleanup complete.\033[0m"

fclean:
	@echo "\033[1;31m"
	@echo "╔─────────────────────────────────────────────────────────────────────────────────╗"
	@echo "│██████╗ ███████╗███╗   ███╗ ██████╗ ██╗   ██╗███████╗     █████╗ ██╗     ██╗     │"
	@echo "│██╔══██╗██╔════╝████╗ ████║██╔═══██╗██║   ██║██╔════╝    ██╔══██╗██║     ██║     │"
	@echo "│██████╔╝█████╗  ██╔████╔██║██║   ██║██║   ██║█████╗      ███████║██║     ██║     │"
	@echo "│██╔══██╗██╔══╝  ██║╚██╔╝██║██║   ██║╚██╗ ██╔╝██╔══╝      ██╔══██║██║     ██║     │"
	@echo "│██║  ██║███████╗██║ ╚═╝ ██║╚██████╔╝ ╚████╔╝ ███████╗    ██║  ██║███████╗███████╗│"
	@echo "│╚═╝  ╚═╝╚══════╝╚═╝     ╚═╝ ╚═════╝   ╚═══╝  ╚══════╝    ╚═╝  ╚═╝╚══════╝╚══════╝│"
	@echo "╚─────────────────────────────────────────────────────────────────────────────────╝"
	@echo "\033[0m"
	@$(DOCKER_COMPOSE) down
	@$(DOCKER) image rm -f $$(sudo docker image ls -q)  2>>./app.log || true
	@$(DOCKER) volume rm $$(sudo docker volume ls -q) 2>>./app.log || true
	@$(DOCKER) builder prune -f
	@sudo rm -fr $(DATA_DIR)
	@echo "\033[1;31mFull clean complete.\033[0m"

status:
	@echo "\033[1;34m"
	@echo "\t\t╔───────────────────────────────────────────────────╗"
	@echo "\t\t│███████╗████████╗ █████╗ ████████╗██╗   ██╗███████╗│"
	@echo "\t\t│██╔════╝╚══██╔══╝██╔══██╗╚══██╔══╝██║   ██║██╔════╝│"
	@echo "\t\t│███████╗   ██║   ███████║   ██║   ██║   ██║███████╗│"
	@echo "\t\t│╚════██║   ██║   ██╔══██║   ██║   ██║   ██║╚════██║│"
	@echo "\t\t│███████║   ██║   ██║  ██║   ██║   ╚██████╔╝███████║│"
	@echo "\t\t│╚══════╝   ╚═╝   ╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚══════╝│"
	@echo "\t\t╚───────────────────────────────────────────────────╝"
	@echo "\033[0m"
	@$(DOCKER) ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Networks}}\t{{.State}}\t{{.CreatedAt}}"
	@echo "\033[1;34mStatus check complete.\033[0m"

re: fclean up
	@echo "\033[1;32mApplication restarted.\033[0m"

logs:
	@echo "Displaying logs of running containers..."
	@$(DOCKER_COMPOSE) logs -f

rebuild:
	@echo "\033[1;33m"
	@echo "\t\t╔────────────────────────────────────────────────────╗"
	@echo "\t\t│██████╗ ███████╗██████╗ ██╗   ██╗██╗██╗     ██████╗ │"
	@echo "\t\t│██╔══██╗██╔════╝██╔══██╗██║   ██║██║██║     ██╔══██╗│"
	@echo "\t\t│██████╔╝█████╗  ██████╔╝██║   ██║██║██║     ██║  ██║│"
	@echo "\t\t│██╔══██╗██╔══╝  ██╔══██╗██║   ██║██║██║     ██║  ██║│"
	@echo "\t\t│██║  ██║███████╗██████╔╝╚██████╔╝██║███████╗██████╔╝│"
	@echo "\t\t│╚═╝  ╚═╝╚══════╝╚═════╝  ╚═════╝ ╚═╝╚══════╝╚═════╝ │"
	@echo "\t\t╚────────────────────────────────────────────────────╝"
	@echo "\033[0m"
	@echo "Rebuilding the containers..."
	@$(DOCKER_COMPOSE) up -d --build --force-recreate
	@echo "Rebuild complete."



help:
	@echo "\033[1;36m"
	@echo "\t\t╔───────────────────────────────────────────────────────────╗"
	@echo "\t\t│ ██████╗███╗   ███╗██████╗     ██╗     ██╗███████╗████████╗│"
	@echo "\t\t│██╔════╝████╗ ████║██╔══██╗    ██║     ██║██╔════╝╚══██╔══╝│"
	@echo "\t\t│██║     ██╔████╔██║██║  ██║    ██║     ██║███████╗   ██║   │"
	@echo "\t\t│██║     ██║╚██╔╝██║██║  ██║    ██║     ██║╚════██║   ██║   │"
	@echo "\t\t│╚██████╗██║ ╚═╝ ██║██████╔╝    ███████╗██║███████║   ██║   │"
	@echo "\t\t│ ╚═════╝╚═╝     ╚═╝╚═════╝     ╚══════╝╚═╝╚══════╝   ╚═╝   │"
	@echo "\t\t╚───────────────────────────────────────────────────────────╝"
	@echo "\033[0m"
	@echo "\033[1;36mAvailable commands:\033[0m"
	@echo "\033[1;36m  make up       \033[0m- Start the application"
	@echo "\033[1;36m  make down     \033[0m- Stop the application"
	@echo "\033[1;36m  make clean    \033[0m- Clean up containers and images"
	@echo "\033[1;36m  make fclean   \033[0m- Perform a full clean"
	@echo "\033[1;36m  make status   \033[0m- Check status of running containers"
	@echo "\033[1;36m  make logs     \033[0m- Display logs of running containers"
	@echo "\033[1;36m  make rebuild  \033[0m- Rebuild the containers"
	@echo "\033[1;36m  make help     \033[0m- Display this help message"

# Silent mode for commands
.SILENT: